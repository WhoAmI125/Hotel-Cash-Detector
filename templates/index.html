<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í˜¸í…” ë³´ì•ˆ ì‹œìŠ¤í…œ - ë¹„ë””ì˜¤ ë¶„ì„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">
  <!-- Header -->
  <header class="bg-slate-800 text-white py-4 px-6 shadow-lg">
    <div class="container mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <i class="fas fa-shield-alt text-2xl"></i>
        <h1 class="text-xl font-semibold">í˜¸í…” ë³´ì•ˆ ì‹œìŠ¤í…œ</h1>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-sm text-gray-300">
          <i class="far fa-clock mr-1"></i>
          <span id="currentTime"></span>
        </div>
        <div class="flex gap-2">
          <span class="bg-green-600 text-white text-xs px-2 py-1 rounded">í˜„ê¸ˆ ê±°ë˜</span>
          <span class="bg-red-600 text-white text-xs px-2 py-1 rounded">í­ë ¥</span>
          <span class="bg-orange-600 text-white text-xs px-2 py-1 rounded">í™”ì¬</span>
        </div>
      </div>
    </div>
  </header>

  <div class="container mx-auto px-6 py-8">
    <!-- Info Banner -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 p-6 mb-6 rounded-r shadow-sm">
      <div class="flex items-start">
        <i class="fas fa-info-circle text-blue-500 text-2xl mr-4 mt-1"></i>
        <div class="flex-1">
          <p class="font-bold text-blue-900 text-lg mb-2">ğŸ¤– ë‹¤ì¤‘ ì´ë²¤íŠ¸ ìë™ ê°ì§€ ì‹œìŠ¤í…œ</p>
          <p class="text-sm text-blue-700 mb-3">ìµœëŒ€ 5ê°œì˜ ë¹„ë””ì˜¤ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”. ì‹œìŠ¤í…œì´ í˜„ê¸ˆ ê±°ë˜, í­ë ¥ í–‰ìœ„, í™”ì¬/ì—°ê¸°ë¥¼ ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³  í´ë¦½ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.</p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs">
            <div class="bg-white bg-opacity-50 p-2 rounded">
              <i class="fas fa-money-bill-wave text-green-600 mr-1"></i>
              <span class="font-semibold">í˜„ê¸ˆ ê±°ë˜:</span> ì† ì ‘ì´‰ ê°ì§€ (100px)
            </div>
            <div class="bg-white bg-opacity-50 p-2 rounded">
              <i class="fas fa-hand-fist text-red-600 mr-1"></i>
              <span class="font-semibold">í­ë ¥:</span> ê³µê²©ì  ì›€ì§ì„ ë¶„ì„
            </div>
            <div class="bg-white bg-opacity-50 p-2 rounded">
              <i class="fas fa-fire text-orange-600 mr-1"></i>
              <span class="font-semibold">í™”ì¬:</span> ìƒ‰ìƒ ê¸°ë°˜ ê°ì§€
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Section -->
    <div class="bg-white rounded-lg shadow-md p-8 mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
        <i class="fas fa-upload text-blue-600 mr-3"></i>
        ë¹„ë””ì˜¤ ì—…ë¡œë“œ
      </h2>

      <div class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-blue-500 transition-colors cursor-pointer" id="dropZone">
        <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
        <p class="text-lg text-gray-700 mb-2">ë¹„ë””ì˜¤ë¥¼ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
        <p class="text-sm text-gray-500 mb-4">ë˜ëŠ” í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</p>
        <input type="file" id="videoInput" accept="video/*" multiple class="hidden">
        <button onclick="document.getElementById('videoInput').click()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors">
          ë¹„ë””ì˜¤ ì„ íƒ
        </button>
        <p class="text-xs text-gray-400 mt-4">ìµœëŒ€ 5ê°œ ë¹„ë””ì˜¤ â€¢ MP4, AVI, MOV, MKV â€¢ ìµœëŒ€ 2GB/ê°œ</p>
      </div>

      <!-- Selected Files -->
      <div id="selectedFiles" class="mt-6 hidden">
        <h3 class="font-semibold text-gray-700 mb-3">ì„ íƒëœ ë¹„ë””ì˜¤:</h3>
        <div id="fileList" class="space-y-2"></div>
        <button id="uploadBtn" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg transition-colors w-full flex items-center justify-center">
          <i class="fas fa-play mr-2"></i>
          ë¶„ì„ ì‹œì‘
        </button>
      </div>
    </div>

    <!-- Processing Status -->
    <div id="processingSection" class="hidden">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
        <i class="fas fa-cog fa-spin text-blue-600 mr-3"></i>
        ë¹„ë””ì˜¤ ë¶„ì„ ì¤‘
      </h2>
      <div id="jobsList" class="space-y-4"></div>
    </div>
  </div>

  <script>
    let selectedFiles = [];
    const MAX_FILES = 5;

    // Update time
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.toLocaleString('ko-KR');
    }
    updateTime();
    setInterval(updateTime, 1000);

    // File input handling
    const fileInput = document.getElementById('videoInput');
    const dropZone = document.getElementById('dropZone');
    const selectedFilesDiv = document.getElementById('selectedFiles');
    const fileListDiv = document.getElementById('fileList');
    const uploadBtn = document.getElementById('uploadBtn');

    fileInput.addEventListener('change', handleFiles);

    // Drag and drop
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('border-blue-500', 'bg-blue-50');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('border-blue-500', 'bg-blue-50');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('border-blue-500', 'bg-blue-50');
      fileInput.files = e.dataTransfer.files;
      handleFiles();
    });

    function handleFiles() {
      const files = Array.from(fileInput.files);
      
      if (files.length > MAX_FILES) {
        alert(`ìµœëŒ€ ${MAX_FILES}ê°œì˜ ë¹„ë””ì˜¤ë§Œ í—ˆìš©ë©ë‹ˆë‹¤!`);
        return;
      }

      selectedFiles = files;
      displaySelectedFiles();
    }

    function displaySelectedFiles() {
      if (selectedFiles.length === 0) {
        selectedFilesDiv.classList.add('hidden');
        return;
      }

      selectedFilesDiv.classList.remove('hidden');
      fileListDiv.innerHTML = '';

      selectedFiles.forEach((file, index) => {
        const fileSize = (file.size / (1024 * 1024)).toFixed(2);
        const fileItem = document.createElement('div');
        fileItem.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg';
        fileItem.innerHTML = `
          <div class="flex items-center gap-3">
            <i class="fas fa-video text-blue-600"></i>
            <div>
              <p class="font-medium text-gray-800">${file.name}</p>
              <p class="text-sm text-gray-500">${fileSize} MB</p>
            </div>
          </div>
          <button onclick="removeFile(${index})" class="text-red-500 hover:text-red-700">
            <i class="fas fa-times"></i>
          </button>
        `;
        fileListDiv.appendChild(fileItem);
      });
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      displaySelectedFiles();
    }

    // Upload and process
    uploadBtn.addEventListener('click', async () => {
      if (selectedFiles.length === 0) return;

      const formData = new FormData();
      selectedFiles.forEach(file => {
        formData.append('videos', file);
      });

      uploadBtn.disabled = true;
      uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì—…ë¡œë“œ ì¤‘...';

      try {
        const response = await fetch('/upload', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        
        if (data.error) {
          alert('ì˜¤ë¥˜: ' + data.error);
          uploadBtn.disabled = false;
          uploadBtn.innerHTML = '<i class="fas fa-play mr-2"></i>ë¶„ì„ ì‹œì‘';
          return;
        }

        // Show processing section
        document.getElementById('processingSection').classList.remove('hidden');
        
        // Monitor each job
        data.jobs.forEach(job => {
          createJobCard(job);
          monitorJob(job.job_id);
        });

        // Reset upload form
        selectedFiles = [];
        fileInput.value = '';
        displaySelectedFiles();
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-play mr-2"></i>ë¶„ì„ ì‹œì‘';

      } catch (error) {
        alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-play mr-2"></i>ë¶„ì„ ì‹œì‘';
      }
    });

    function createJobCard(job) {
      const jobCard = document.createElement('div');
      jobCard.id = `job-${job.job_id}`;
      jobCard.className = 'bg-white rounded-lg shadow-md p-6';
      jobCard.innerHTML = `
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <i class="fas fa-video text-blue-600 text-xl"></i>
            <div>
              <h3 class="font-semibold text-gray-800">${job.filename}</h3>
              <p class="text-sm text-gray-500" id="stage-${job.job_id}">ì´ˆê¸°í™” ì¤‘...</p>
            </div>
          </div>
          <span class="text-sm font-semibold text-blue-600" id="progress-text-${job.job_id}">0%</span>
        </div>
        
        <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
          <div id="progress-bar-${job.job_id}" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        
        <div id="results-${job.job_id}" class="hidden mt-4">
          <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
            <p class="font-semibold text-green-800">
              <i class="fas fa-check-circle mr-2"></i>
              ë¶„ì„ ì™„ë£Œ
            </p>
            <p class="text-sm text-green-700" id="summary-${job.job_id}"></p>
          </div>
          <div id="clips-${job.job_id}" class="space-y-2"></div>
        </div>
      `;
      
      document.getElementById('jobsList').appendChild(jobCard);
    }

    async function monitorJob(jobId) {
      const interval = setInterval(async () => {
        try {
          const response = await fetch(`/status/${jobId}`);
          const status = await response.json();

          // Update progress
          document.getElementById(`progress-bar-${jobId}`).style.width = status.progress + '%';
          document.getElementById(`progress-text-${jobId}`).textContent = status.progress + '%';
          document.getElementById(`stage-${jobId}`).textContent = status.stage || 'Processing...';

          if (status.status === 'completed') {
            clearInterval(interval);
            showResults(jobId, status);
          } else if (status.status === 'error') {
            clearInterval(interval);
            showError(jobId, status.error);
          }
        } catch (error) {
          console.error('Error monitoring job:', error);
        }
      }, 1000);
    }

    function showResults(jobId, status) {
      const resultsDiv = document.getElementById(`results-${jobId}`);
      const clipsDiv = document.getElementById(`clips-${jobId}`);
      const summaryDiv = document.getElementById(`summary-${jobId}`);

      resultsDiv.classList.remove('hidden');

      if (status.clips && status.clips.length > 0) {
        summaryDiv.innerHTML = `${status.clips.length}ê°œì˜ ì´ë²¤íŠ¸ ê°ì§€ë¨`;

        // Add view all button
        clipsDiv.innerHTML = `
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-semibold text-gray-700">ì¶”ì¶œëœ í´ë¦½:</h4>
            <a href="/results/${jobId}" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
              <i class="fas fa-eye mr-2"></i>
              ì „ì²´ ê²°ê³¼ ë³´ê¸°
            </a>
          </div>
        `;
        
        // Show first 3 clips as preview
        const previewClips = status.clips.slice(0, 3);
        previewClips.forEach((clip, index) => {
          const eventType = clip.type || 'CASH_EXCHANGE';
          let icon, color, bgColor, label;
          
          if (eventType === 'VIOLENCE') {
            icon = 'hand-fist';
            color = 'red';
            bgColor = 'bg-red-50';
            label = clip.label || 'í­ë ¥';
          } else if (eventType === 'FIRE') {
            icon = 'fire';
            color = 'orange';
            bgColor = 'bg-orange-50';
            label = clip.label || 'í™”ì¬';
          } else {
            icon = 'money-bill-wave';
            color = 'green';
            bgColor = 'bg-green-50';
            label = clip.label || 'í˜„ê¸ˆ ê±°ë˜';
          }
          
          const clipItem = document.createElement('div');
          clipItem.className = `flex items-center justify-between ${bgColor} p-3 rounded-lg border border-${color}-200`;
          clipItem.innerHTML = `
            <div class="flex items-center gap-3 flex-1">
              <i class="fas fa-${icon} text-${color}-600 text-xl"></i>
              <div>
                <p class="font-medium text-gray-800">${label} ${index + 1}</p>
                <p class="text-sm text-gray-600">ì‹œê°„: ${clip.start_time}s - ${clip.end_time}s (${clip.duration}s)</p>
              </div>
            </div>
            <a href="/download/${jobId}/${clip.filename}" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm transition-colors">
              <i class="fas fa-download"></i>
            </a>
          `;
          clipsDiv.appendChild(clipItem);
        });
        
        if (status.clips.length > 3) {
          const moreDiv = document.createElement('div');
          moreDiv.className = 'text-center mt-2';
          moreDiv.innerHTML = `
            <a href="/results/${jobId}" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
              +${status.clips.length - 3}ê°œ ë” ë³´ê¸° â†’
            </a>
          `;
          clipsDiv.appendChild(moreDiv);
        }
      } else {
        summaryDiv.textContent = status.message || 'ê°ì§€ëœ ì´ë²¤íŠ¸ ì—†ìŒ';
      }
    }

    function showError(jobId, error) {
      const resultsDiv = document.getElementById(`results-${jobId}`);
      resultsDiv.classList.remove('hidden');
      resultsDiv.innerHTML = `
        <div class="bg-red-50 border-l-4 border-red-500 p-4">
          <p class="font-semibold text-red-800">
            <i class="fas fa-exclamation-circle mr-2"></i>
            ì˜¤ë¥˜ ë°œìƒ
          </p>
          <p class="text-sm text-red-700">${error}</p>
        </div>
      `;
    }
  </script>
</body>
</html>

