<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Security Monitor | CCTV Detection System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        dark: {
                            900: '#0a0a0f',
                            800: '#12121a',
                            700: '#1a1a25',
                            600: '#252532',
                            500: '#32324a',
                        },
                        accent: {
                            blue: '#3b82f6',
                            green: '#22c55e',
                            red: '#ef4444',
                            orange: '#f97316',
                            purple: '#8b5cf6',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #12121a 100%);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a25; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 3px; }
        
        /* Glass effect */
        .glass {
            background: rgba(26, 26, 37, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Card hover effect */
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        /* Pulse animation */
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-slow {
            animation: pulse-slow 2s ease-in-out infinite;
        }
        
        /* Slide in animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        /* Video container */
        .video-wrapper {
            position: relative;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
        }
        
        .video-wrapper::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 16px;
            padding: 1px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(139, 92, 246, 0.3));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }
        
        /* Stats card gradient */
        .stat-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        /* Detection toggle */
        .toggle-btn {
            transition: all 0.3s ease;
        }
        .toggle-btn.active {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
        }
        .toggle-btn.inactive {
            opacity: 0.5;
        }
        
        /* Alert badge */
        .alert-badge {
            position: relative;
        }
        .alert-badge::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse-slow 1s ease-in-out infinite;
        }
    </style>
</head>
<body class="min-h-screen text-white">
    <!-- Top Navigation -->
    <nav class="glass sticky top-0 z-50 px-6 py-4 border-b border-dark-600">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <!-- Logo -->
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-accent-blue to-accent-purple flex items-center justify-center">
                    <i class="fas fa-shield-halved text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-semibold">Hotel Security Monitor</h1>
                    <p class="text-xs text-gray-400">CCTV Detection System</p>
                </div>
            </div>
            
            <!-- Status & Controls -->
            <div class="flex items-center gap-6">
                <!-- Connection Status -->
                <div class="flex items-center gap-2 px-4 py-2 rounded-full bg-dark-700">
                    <div id="status-dot" class="w-2 h-2 rounded-full bg-accent-green animate-pulse-slow"></div>
                    <span id="status-text" class="text-sm text-gray-300">Connected</span>
                </div>
                
                <!-- Detection Toggles -->
                <div class="flex items-center gap-2">
                    <button onclick="toggleDetection('cash')" id="btn-cash" 
                            class="toggle-btn active flex items-center gap-2 px-4 py-2 rounded-full bg-accent-green/20 border border-accent-green/50 text-accent-green text-sm font-medium hover:bg-accent-green/30 transition">
                        <i class="fas fa-money-bill-wave"></i>
                        <span class="hidden sm:inline">Cash</span>
                    </button>
                    <button onclick="toggleDetection('violence')" id="btn-violence" 
                            class="toggle-btn active flex items-center gap-2 px-4 py-2 rounded-full bg-accent-red/20 border border-accent-red/50 text-accent-red text-sm font-medium hover:bg-accent-red/30 transition">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span class="hidden sm:inline">Violence</span>
                    </button>
                    <button onclick="toggleDetection('fire')" id="btn-fire" 
                            class="toggle-btn active flex items-center gap-2 px-4 py-2 rounded-full bg-accent-orange/20 border border-accent-orange/50 text-accent-orange text-sm font-medium hover:bg-accent-orange/30 transition">
                        <i class="fas fa-fire"></i>
                        <span class="hidden sm:inline">Fire</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <div class="grid grid-cols-12 gap-6">
            
            <!-- Left Column - Video & Controls -->
            <div class="col-span-12 lg:col-span-8 space-y-6">
                
                <!-- Video Player Card -->
                <div class="glass rounded-2xl p-6 card-hover">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-accent-blue/20 flex items-center justify-center">
                                <i class="fas fa-video text-accent-blue"></i>
                            </div>
                            <div>
                                <h2 class="font-semibold">Live Feed</h2>
                                <p class="text-xs text-gray-400">Real-time monitoring</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <!-- Video Source Selector -->
                            <select id="video-select" onchange="changeVideo()" 
                                    class="bg-dark-700 border border-dark-500 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-accent-blue transition cursor-pointer">
                                <option value="">Select Video Source</option>
                                {% for video in videos %}
                                <option value="{{ video.path }}">{{ video.name }}</option>
                                {% endfor %}
                            </select>
                            
                            <!-- Stop Button -->
                            <button onclick="stopProcessing()" 
                                    class="flex items-center gap-2 px-4 py-2 rounded-lg bg-accent-red/20 border border-accent-red/50 text-accent-red text-sm font-medium hover:bg-accent-red/30 transition">
                                <i class="fas fa-stop"></i>
                                <span>Stop</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Zone Drawing Instructions -->
                    <div id="zone-instructions" class="hidden mb-4 p-4 rounded-xl bg-accent-orange/10 border border-accent-orange/30">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-draw-polygon text-accent-orange text-xl"></i>
                            <div>
                                <p class="font-medium text-accent-orange">Drawing Mode Active</p>
                                <p class="text-sm text-gray-400">Click and drag on the video to draw the cashier zone rectangle</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Video Container -->
                    <div class="video-wrapper" id="video-wrapper">
                        <img id="video-feed" src="" alt="Video Feed" 
                             class="w-full" style="min-height: 450px; background: linear-gradient(135deg, #0a0a0f 0%, #1a1a25 100%);">
                        
                        <!-- Canvas overlay for drawing zone -->
                        <canvas id="zone-canvas" class="absolute top-0 left-0 w-full h-full hidden" style="cursor: crosshair;"></canvas>
                        
                        <!-- Video Overlay - Top Left -->
                        <div class="absolute top-4 left-4 flex items-center gap-3">
                            <div class="px-3 py-1.5 rounded-lg bg-black/70 backdrop-blur text-sm">
                                <span id="frame-counter" class="text-gray-300">Frame: 0</span>
                            </div>
                        </div>
                        
                        <!-- Video Overlay - Top Right -->
                        <div class="absolute top-4 right-4">
                            <span id="live-badge" class="px-3 py-1.5 rounded-lg bg-accent-red font-medium text-sm animate-pulse-slow">
                                <i class="fas fa-circle text-xs mr-1.5"></i>LIVE
                            </span>
                        </div>
                        
                        <!-- No Video Placeholder -->
                        <div id="no-video-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500">
                            <i class="fas fa-video-slash text-5xl mb-4 opacity-50"></i>
                            <p class="text-lg font-medium">No Video Selected</p>
                            <p class="text-sm">Choose a video source to start monitoring</p>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="stat-card rounded-xl p-5 card-hover">
                        <div class="flex items-center justify-between mb-3">
                            <div class="w-10 h-10 rounded-lg bg-accent-green/20 flex items-center justify-center">
                                <i class="fas fa-money-bill-wave text-accent-green"></i>
                            </div>
                            <span class="text-3xl font-bold text-accent-green" id="stat-cash">0</span>
                        </div>
                        <p class="text-sm text-gray-400">Cash Transactions</p>
                    </div>
                    
                    <div class="stat-card rounded-xl p-5 card-hover">
                        <div class="flex items-center justify-between mb-3">
                            <div class="w-10 h-10 rounded-lg bg-accent-red/20 flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-accent-red"></i>
                            </div>
                            <span class="text-3xl font-bold text-accent-red" id="stat-violence">0</span>
                        </div>
                        <p class="text-sm text-gray-400">Violence Detected</p>
                    </div>
                    
                    <div class="stat-card rounded-xl p-5 card-hover">
                        <div class="flex items-center justify-between mb-3">
                            <div class="w-10 h-10 rounded-lg bg-accent-orange/20 flex items-center justify-center">
                                <i class="fas fa-fire text-accent-orange"></i>
                            </div>
                            <span class="text-3xl font-bold text-accent-orange" id="stat-fire">0</span>
                        </div>
                        <p class="text-sm text-gray-400">Fire/Smoke Alerts</p>
                    </div>
                </div>
                
                <!-- Upload Section -->
                <div class="glass rounded-2xl p-6 card-hover">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-accent-purple/20 flex items-center justify-center">
                            <i class="fas fa-cloud-upload-alt text-accent-purple"></i>
                        </div>
                        <div>
                            <h2 class="font-semibold">Upload Video</h2>
                            <p class="text-xs text-gray-400">Add new video for analysis</p>
                        </div>
                    </div>
                    
                    <div class="border-2 border-dashed border-dark-500 rounded-xl p-8 text-center hover:border-accent-purple/50 transition cursor-pointer group"
                         onclick="document.getElementById('file-input').click()">
                        <input type="file" id="file-input" accept="video/*" class="hidden" onchange="uploadVideo(this)">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-dark-600 flex items-center justify-center group-hover:bg-accent-purple/20 transition">
                            <i class="fas fa-film text-2xl text-gray-500 group-hover:text-accent-purple transition"></i>
                        </div>
                        <p class="text-gray-300 font-medium mb-1">Drop video file here or click to upload</p>
                        <p class="text-gray-500 text-sm">Supports MP4, AVI, MOV, MKV (max 500MB)</p>
                    </div>
                    
                    <!-- Upload Progress -->
                    <div id="upload-progress" class="hidden mt-4">
                        <div class="flex items-center justify-between mb-2">
                            <span id="upload-filename" class="text-sm text-gray-300 truncate">Uploading...</span>
                            <span id="upload-percent" class="text-sm font-medium text-accent-purple">0%</span>
                        </div>
                        <div class="w-full bg-dark-600 rounded-full h-2 overflow-hidden">
                            <div id="upload-bar" class="bg-gradient-to-r from-accent-blue to-accent-purple h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column - Alerts & Settings -->
            <div class="col-span-12 lg:col-span-4 space-y-6">
                
                <!-- Alerts Panel -->
                <div class="glass rounded-2xl p-6 card-hover">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-accent-red/20 flex items-center justify-center alert-badge">
                                <i class="fas fa-bell text-accent-red"></i>
                            </div>
                            <div>
                                <h2 class="font-semibold">Recent Alerts</h2>
                                <p class="text-xs text-gray-400">Real-time notifications</p>
                            </div>
                        </div>
                        <span id="alert-count" class="px-2.5 py-1 rounded-full bg-accent-red/20 text-accent-red text-xs font-semibold">0</span>
                    </div>
                    
                    <div id="alerts-container" class="space-y-3 max-h-[400px] overflow-y-auto pr-1">
                        <!-- Alert items will be inserted here -->
                        <div id="no-alerts" class="text-center py-12">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-dark-600 flex items-center justify-center">
                                <i class="fas fa-shield-check text-2xl text-gray-600"></i>
                            </div>
                            <p class="text-gray-400 font-medium">All Clear</p>
                            <p class="text-gray-500 text-sm mt-1">No alerts detected</p>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="glass rounded-2xl p-6 card-hover">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-accent-blue/20 flex items-center justify-center">
                            <i class="fas fa-bolt text-accent-blue"></i>
                        </div>
                        <div>
                            <h2 class="font-semibold">Quick Actions</h2>
                            <p class="text-xs text-gray-400">Tools & Settings</p>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <button onclick="toggleDebugMode()" id="btn-debug"
                                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-dark-600 hover:bg-dark-500 transition text-left group">
                            <div class="w-8 h-8 rounded-lg bg-accent-purple/20 flex items-center justify-center">
                                <i class="fas fa-bug text-accent-purple"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-sm">Debug Mode</p>
                                <p class="text-xs text-gray-500">Show detection details</p>
                            </div>
                            <span id="debug-status" class="px-2 py-1 rounded text-xs font-medium bg-dark-700 text-gray-400">OFF</span>
                        </button>
                        
                        <button onclick="startDrawCashierZone()" id="btn-draw-zone"
                                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-dark-600 hover:bg-dark-500 transition text-left group">
                            <div class="w-8 h-8 rounded-lg bg-accent-orange/20 flex items-center justify-center">
                                <i class="fas fa-draw-polygon text-accent-orange"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-sm">Draw Cashier Zone</p>
                                <p class="text-xs text-gray-500">Set detection area</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-600 group-hover:text-gray-400 transition"></i>
                        </button>
                        
                        <button onclick="clearAlerts()" 
                                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-dark-600 hover:bg-dark-500 transition text-left group">
                            <div class="w-8 h-8 rounded-lg bg-accent-red/20 flex items-center justify-center">
                                <i class="fas fa-trash-alt text-accent-red"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-sm">Clear Alerts</p>
                                <p class="text-xs text-gray-500">Remove all notifications</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-600 group-hover:text-gray-400 transition"></i>
                        </button>
                        
                        <button onclick="exportReport()" 
                                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-dark-600 hover:bg-dark-500 transition text-left group">
                            <div class="w-8 h-8 rounded-lg bg-accent-blue/20 flex items-center justify-center">
                                <i class="fas fa-file-export text-accent-blue"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-sm">Export Report</p>
                                <p class="text-xs text-gray-500">Download as JSON</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-600 group-hover:text-gray-400 transition"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Zone Info -->
                <div id="zone-info" class="hidden glass rounded-2xl p-6 card-hover">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-accent-green/20 flex items-center justify-center">
                            <i class="fas fa-vector-square text-accent-green"></i>
                        </div>
                        <div>
                            <h2 class="font-semibold">Cashier Zone</h2>
                            <p class="text-xs text-gray-400">Current detection area</p>
                        </div>
                    </div>
                    <div class="bg-dark-700 rounded-lg p-4">
                        <code id="zone-coords" class="text-sm text-accent-green font-mono">Not configured</code>
                    </div>
                </div>
                
                <!-- Detection Info -->
                <div class="glass rounded-2xl p-6 card-hover">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-accent-blue/20 flex items-center justify-center">
                            <i class="fas fa-info-circle text-accent-blue"></i>
                        </div>
                        <div>
                            <h2 class="font-semibold">Detection Info</h2>
                            <p class="text-xs text-gray-400">How it works</p>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="p-3 rounded-lg bg-accent-green/10 border border-accent-green/20">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="fas fa-money-bill-wave text-accent-green text-sm"></i>
                                <span class="font-medium text-sm text-accent-green">Cash Detection</span>
                            </div>
                            <p class="text-xs text-gray-400">Detects hand-to-hand exchanges between people inside and outside the cashier zone</p>
                        </div>
                        
                        <div class="p-3 rounded-lg bg-accent-red/10 border border-accent-red/20">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="fas fa-exclamation-triangle text-accent-red text-sm"></i>
                                <span class="font-medium text-sm text-accent-red">Violence Detection</span>
                            </div>
                            <p class="text-xs text-gray-400">Requires two people in close physical contact with rapid aggressive movements</p>
                        </div>
                        
                        <div class="p-3 rounded-lg bg-accent-orange/10 border border-accent-orange/20">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="fas fa-fire text-accent-orange text-sm"></i>
                                <span class="font-medium text-sm text-accent-orange">Fire Detection</span>
                            </div>
                            <p class="text-xs text-gray-400">Uses trained YOLO model to detect fire and smoke with high accuracy</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="border-t border-dark-600 mt-12 py-6">
        <div class="max-w-7xl mx-auto px-6 text-center text-gray-500 text-sm">
            <p>Hotel Security Monitor &copy; 2025 | Powered by YOLOv8 & OpenCV</p>
        </div>
    </footer>
    
    <!-- Alert Sound -->
    <audio id="alert-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleTeO2uoQAAAA" type="audio/wav">
    </audio>
    
    <script>
        // Socket connection
        const socket = io();
        
        // State
        let detectionEnabled = { cash: true, violence: true, fire: true };
        let debugMode = false;
        let stats = { cash: 0, violence: 0, fire: 0 };
        let alerts = [];
        
        // Socket events
        socket.on('connect', () => {
            updateStatus(true);
            console.log('Connected to server');
        });
        
        socket.on('disconnect', () => {
            updateStatus(false);
            console.log('Disconnected from server');
        });
        
        socket.on('detections', (data) => {
            console.log('Detection:', data);
            data.detections.forEach(det => {
                addAlert(det);
                updateStats(det.label);
                playAlertSound(det.label);
            });
        });
        
        // Functions
        function updateStatus(connected) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            
            if (connected) {
                dot.classList.remove('bg-accent-red');
                dot.classList.add('bg-accent-green');
                text.textContent = 'Connected';
            } else {
                dot.classList.remove('bg-accent-green');
                dot.classList.add('bg-accent-red');
                text.textContent = 'Disconnected';
            }
        }
        
        function changeVideo() {
            const select = document.getElementById('video-select');
            const videoPath = select.value;
            const placeholder = document.getElementById('no-video-placeholder');
            
            if (videoPath) {
                const videoFeed = document.getElementById('video-feed');
                videoFeed.src = `/video_feed?path=${encodeURIComponent(videoPath)}`;
                placeholder.classList.add('hidden');
            } else {
                placeholder.classList.remove('hidden');
            }
        }
        
        function stopProcessing() {
            fetch('/stop_processing').then(res => res.json()).then(data => {
                console.log('Stopped processing');
            });
        }
        
        function toggleDetection(type) {
            detectionEnabled[type] = !detectionEnabled[type];
            const btn = document.getElementById(`btn-${type}`);
            
            if (detectionEnabled[type]) {
                btn.classList.remove('inactive');
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
                btn.classList.add('inactive');
            }
            
            fetch('/toggle_detection', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: type, enabled: detectionEnabled[type] })
            });
        }
        
        function toggleDebugMode() {
            debugMode = !debugMode;
            const status = document.getElementById('debug-status');
            
            if (debugMode) {
                status.textContent = 'ON';
                status.classList.remove('bg-dark-700', 'text-gray-400');
                status.classList.add('bg-accent-purple/20', 'text-accent-purple');
            } else {
                status.textContent = 'OFF';
                status.classList.remove('bg-accent-purple/20', 'text-accent-purple');
                status.classList.add('bg-dark-700', 'text-gray-400');
            }
            
            fetch('/toggle_debug', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: debugMode })
            });
        }
        
        function addAlert(detection) {
            const container = document.getElementById('alerts-container');
            const noAlerts = document.getElementById('no-alerts');
            
            if (noAlerts) noAlerts.classList.add('hidden');
            
            const colors = {
                'CASH': { bg: 'bg-accent-green/10', border: 'border-accent-green/30', text: 'text-accent-green', icon: 'fa-money-bill-wave' },
                'VIOLENCE': { bg: 'bg-accent-red/10', border: 'border-accent-red/30', text: 'text-accent-red', icon: 'fa-exclamation-triangle' },
                'FIRE': { bg: 'bg-accent-orange/10', border: 'border-accent-orange/30', text: 'text-accent-orange', icon: 'fa-fire' }
            };
            
            const style = colors[detection.label] || colors['CASH'];
            const time = new Date().toLocaleTimeString();
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `slide-in ${style.bg} ${style.border} border rounded-xl p-4`;
            alertDiv.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-lg ${style.bg} flex items-center justify-center flex-shrink-0">
                        <i class="fas ${style.icon} ${style.text}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <span class="font-semibold text-sm ${style.text}">${detection.label}</span>
                            <span class="text-xs text-gray-500">${time}</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Confidence: ${(detection.confidence * 100).toFixed(1)}%</p>
                    </div>
                </div>
            `;
            
            container.insertBefore(alertDiv, container.firstChild);
            
            alerts.unshift(detection);
            if (alerts.length > 50) {
                alerts.pop();
                if (container.children.length > 50) {
                    container.removeChild(container.lastChild);
                }
            }
            
            document.getElementById('alert-count').textContent = alerts.length;
        }
        
        function updateStats(label) {
            if (label === 'CASH') stats.cash++;
            if (label === 'VIOLENCE') stats.violence++;
            if (label === 'FIRE') stats.fire++;
            
            document.getElementById('stat-cash').textContent = stats.cash;
            document.getElementById('stat-violence').textContent = stats.violence;
            document.getElementById('stat-fire').textContent = stats.fire;
        }
        
        function playAlertSound(label) {
            if (label === 'VIOLENCE' || label === 'FIRE') {
                const sound = document.getElementById('alert-sound');
                sound.play().catch(() => {});
            }
        }
        
        function clearAlerts() {
            alerts = [];
            stats = { cash: 0, violence: 0, fire: 0 };
            
            document.getElementById('stat-cash').textContent = '0';
            document.getElementById('stat-violence').textContent = '0';
            document.getElementById('stat-fire').textContent = '0';
            
            const container = document.getElementById('alerts-container');
            container.innerHTML = `
                <div id="no-alerts" class="text-center py-12">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-dark-600 flex items-center justify-center">
                        <i class="fas fa-shield-check text-2xl text-gray-600"></i>
                    </div>
                    <p class="text-gray-400 font-medium">All Clear</p>
                    <p class="text-gray-500 text-sm mt-1">No alerts detected</p>
                </div>
            `;
            document.getElementById('alert-count').textContent = '0';
        }
        
        function uploadVideo(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('video', file);
            
            const progress = document.getElementById('upload-progress');
            const bar = document.getElementById('upload-bar');
            const percent = document.getElementById('upload-percent');
            const filename = document.getElementById('upload-filename');
            
            progress.classList.remove('hidden');
            filename.textContent = file.name;
            
            const xhr = new XMLHttpRequest();
            
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const pct = Math.round((e.loaded / e.total) * 100);
                    bar.style.width = pct + '%';
                    percent.textContent = pct + '%';
                }
            };
            
            xhr.onload = () => {
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    
                    const select = document.getElementById('video-select');
                    const option = document.createElement('option');
                    option.value = data.path;
                    option.textContent = data.filename;
                    select.appendChild(option);
                    select.value = data.path;
                    
                    changeVideo();
                    
                    setTimeout(() => {
                        progress.classList.add('hidden');
                        bar.style.width = '0%';
                    }, 1000);
                }
            };
            
            xhr.open('POST', '/upload');
            xhr.send(formData);
        }
        
        // Cashier Zone Drawing
        let isDrawingZone = false;
        let isDragging = false;
        let zoneStart = null;
        let zoneEnd = null;
        let currentZone = null;
        
        function startDrawCashierZone() {
            const canvas = document.getElementById('zone-canvas');
            const videoFeed = document.getElementById('video-feed');
            const instructions = document.getElementById('zone-instructions');
            const btn = document.getElementById('btn-draw-zone');
            
            if (!videoFeed.src || videoFeed.src === '' || videoFeed.src === window.location.href) {
                alert('Please select a video first');
                return;
            }
            
            canvas.classList.remove('hidden');
            instructions.classList.remove('hidden');
            
            const rect = videoFeed.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            canvas.style.pointerEvents = 'auto';
            
            isDrawingZone = true;
            isDragging = false;
            
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', drawing);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('mouseleave', endDraw);
        }
        
        function cancelDrawZone() {
            const canvas = document.getElementById('zone-canvas');
            const instructions = document.getElementById('zone-instructions');
            
            canvas.classList.add('hidden');
            instructions.classList.add('hidden');
            
            canvas.removeEventListener('mousedown', startDraw);
            canvas.removeEventListener('mousemove', drawing);
            canvas.removeEventListener('mouseup', endDraw);
            canvas.removeEventListener('mouseleave', endDraw);
            
            isDrawingZone = false;
            isDragging = false;
            zoneStart = null;
            zoneEnd = null;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        function startDraw(e) {
            if (!isDrawingZone) return;
            e.preventDefault();
            isDragging = true;
            const rect = e.target.getBoundingClientRect();
            zoneStart = { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }
        
        function drawing(e) {
            if (!isDrawingZone || !isDragging || !zoneStart) return;
            e.preventDefault();
            
            const canvas = document.getElementById('zone-canvas');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            
            zoneEnd = { x: e.clientX - rect.left, y: e.clientY - rect.top };
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#f97316';
            ctx.lineWidth = 3;
            ctx.setLineDash([8, 4]);
            ctx.strokeRect(zoneStart.x, zoneStart.y, zoneEnd.x - zoneStart.x, zoneEnd.y - zoneStart.y);
            ctx.fillStyle = 'rgba(249, 115, 22, 0.1)';
            ctx.fillRect(zoneStart.x, zoneStart.y, zoneEnd.x - zoneStart.x, zoneEnd.y - zoneStart.y);
        }
        
        function endDraw(e) {
            if (!isDrawingZone || !isDragging || !zoneStart) return;
            e.preventDefault();
            isDragging = false;
            
            const canvas = document.getElementById('zone-canvas');
            const videoFeed = document.getElementById('video-feed');
            const rect = canvas.getBoundingClientRect();
            
            zoneEnd = { x: e.clientX - rect.left, y: e.clientY - rect.top };
            
            const canvasW = Math.abs(zoneEnd.x - zoneStart.x);
            const canvasH = Math.abs(zoneEnd.y - zoneStart.y);
            
            if (canvasW < 10 || canvasH < 10) return;
            
            const videoWidth = videoFeed.naturalWidth || canvas.width;
            const videoHeight = videoFeed.naturalHeight || canvas.height;
            const scaleX = canvas.width > 0 ? videoWidth / canvas.width : 1;
            const scaleY = canvas.height > 0 ? videoHeight / canvas.height : 1;
            
            const x = Math.round(Math.min(zoneStart.x, zoneEnd.x) * scaleX);
            const y = Math.round(Math.min(zoneStart.y, zoneEnd.y) * scaleY);
            const w = Math.round(canvasW * scaleX);
            const h = Math.round(canvasH * scaleY);
            
            currentZone = [x, y, w, h];
            
            fetch('/set_cashier_zone', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ zone: currentZone })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('zone-info').classList.remove('hidden');
                    document.getElementById('zone-coords').textContent = `X: ${x}, Y: ${y}, W: ${w}, H: ${h}`;
                    cancelDrawZone();
                }
            });
        }
        
        function exportReport() {
            fetch('/get_summary')
                .then(res => res.json())
                .then(data => {
                    const report = JSON.stringify(data, null, 2);
                    const blob = new Blob([report], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `security_report_${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                });
        }
        
        // Auto-start first video if available
        window.onload = () => {
            const select = document.getElementById('video-select');
            if (select.options.length > 1) {
                select.selectedIndex = 1;
                changeVideo();
            }
            
            fetch('/get_cashier_zone')
                .then(res => res.json())
                .then(data => {
                    if (data.zone && data.zone.length === 4) {
                        currentZone = data.zone;
                        document.getElementById('zone-info').classList.remove('hidden');
                        document.getElementById('zone-coords').textContent = 
                            `X: ${data.zone[0]}, Y: ${data.zone[1]}, W: ${data.zone[2]}, H: ${data.zone[3]}`;
                    }
                })
                .catch(() => {});
        };
    </script>
</body>
</html>
