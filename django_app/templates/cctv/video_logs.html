{% extends 'cctv/base.html' %}

{% block title %}{{ t.video_logs_title }} - {{ t.app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-left">
        <p class="eyebrow">{{ t.video_logs_subtitle }}</p>
        <h1>{{ t.video_logs_title }}</h1>
    </div>
</div>

<!-- Filters -->
<div class="filters">
    <div class="filter-group">
        <label>{{ t.select_region }}</label>
        <select id="regionFilter" onchange="filterBranchesByRegion()">
            <option value="">{{ t.all_regions }}</option>
            {% for region in regions %}
            <option value="{{ region.id }}">{{ region.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-group">
        <label>{{ t.select_branch }}</label>
        <select id="branchFilter">
            <option value="">{{ t.all_branches }}</option>
            {% for branch in branches %}
            <option value="{{ branch.id }}" data-region="{{ branch.region.id }}">{{ branch.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-group">
        <label>{{ t.event_type }}</label>
        <select id="eventTypeFilter">
            <option value="">All</option>
            <option value="cash">{{ t.event_cash }}</option>
            <option value="violence">{{ t.event_violence }}</option>
            <option value="fire">{{ t.event_fire }}</option>
        </select>
    </div>
    <div class="filter-group">
        <label>{{ t.from_date }}</label>
        <input type="date" id="dateFrom">
    </div>
    <div class="filter-group">
        <label>{{ t.to_date }}</label>
        <input type="date" id="dateTo">
    </div>
    <button class="btn btn-secondary" onclick="applyFilters()">{{ t.apply_filter }}</button>
</div>

<!-- Three Column Layout -->
<div class="video-three-col">
    <!-- Event List -->
    <div class="video-col">
        <div class="panel">
            <h3 style="margin-bottom: 12px;">{{ t.nav_video_logs }}</h3>
            <div class="event-list" id="eventList">
                {% for event in events %}
                <div class="event-item" data-id="{{ event.id }}" onclick="selectEvent({{ event.id }})">
                    <div class="branch-cell">
                        <span class="branch-name">{{ event.branch.name }}</span>
                        <span class="camera-name">{{ event.camera.name }}</span>
                    </div>
                    <span class="event-type-badge {{ event.event_type }}">
                        {% if event.event_type == 'cash' %}{{ t.event_cash }}
                        {% elif event.event_type == 'violence' %}{{ t.event_violence }}
                        {% elif event.event_type == 'fire' %}{{ t.event_fire }}
                        {% endif %}
                    </span>
                    <span>{{ event.created_at|date:"H:i" }}</span>
                    <span class="status-pill status-{{ event.status }}">
                        {% if event.status == 'confirmed' %}{{ t.status_confirmed }}
                        {% elif event.status == 'reviewing' %}{{ t.status_reviewing }}
                        {% else %}{{ t.status_pending }}
                        {% endif %}
                    </span>
                </div>
                {% empty %}
                <div class="empty-state">
                    <p class="empty-state-text">{{ t.no_events }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Video Viewer -->
    <div class="video-col">
        <div class="panel video-viewer">
            <div class="viewer-header">
                <h3 id="viewerTitle">{{ t.no_events }}</h3>
            </div>
            <div class="viewer-body" id="viewerBody">
                <span>{{ t.no_events }}</span>
            </div>
        </div>
    </div>
    
    <!-- Status Panel -->
    <div class="video-col">
        <div class="panel">
            <h3 style="margin-bottom: 16px;">{{ t.status }}</h3>
            <div class="status-panel" id="statusPanel">
                <div class="status-row">
                    <span class="status-label">{{ t.branch_name }}</span>
                    <span class="status-value" id="statusBranch">-</span>
                </div>
                <div class="status-row">
                    <span class="status-label">{{ t.camera }}</span>
                    <span class="status-value" id="statusCamera">-</span>
                </div>
                <div class="status-row">
                    <span class="status-label">{{ t.event_type }}</span>
                    <span class="status-value" id="statusType">-</span>
                </div>
                <div class="status-row">
                    <span class="status-label">{{ t.confidence }}</span>
                    <span class="status-value" id="statusConfidence">-</span>
                </div>
                <div class="status-row">
                    <span class="status-label">{{ t.time }}</span>
                    <span class="status-value" id="statusTime">-</span>
                </div>
                <div class="status-row">
                    <span class="status-label">{{ t.status }}</span>
                    <span id="statusStatus">-</span>
                </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 8px;">
                <button class="btn btn-primary btn-sm" onclick="updateEventStatus('confirmed')">{{ t.status_confirmed }}</button>
                <button class="btn btn-secondary btn-sm" onclick="updateEventStatus('reviewing')">{{ t.status_reviewing }}</button>
                <button class="btn btn-danger btn-sm" onclick="deleteEvent()">{{ t.delete }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedEventId = null;
    
    function selectEvent(eventId) {
        selectedEventId = eventId;
        
        // Highlight selected
        document.querySelectorAll('.event-item').forEach(el => el.classList.remove('active'));
        document.querySelector(`.event-item[data-id="${eventId}"]`).classList.add('active');
        
        // Load event details
        loadEventDetails(eventId);
    }
    
    async function loadEventDetails(eventId) {
        try {
            const response = await fetch(`/api/events/${eventId}/`);
            const event = await response.json();
            
            document.getElementById('viewerTitle').textContent = `${event.branch_name} - ${event.camera_name}`;
            document.getElementById('statusBranch').textContent = event.branch_name;
            document.getElementById('statusCamera').textContent = event.camera_name;
            document.getElementById('statusType').textContent = event.event_type;
            document.getElementById('statusConfidence').textContent = (event.confidence * 100).toFixed(1) + '%';
            document.getElementById('statusTime').textContent = event.created_at;
            document.getElementById('statusStatus').innerHTML = `<span class="status-pill status-${event.status}">${event.status}</span>`;
            
            // Show live feed from the camera
            const viewerBody = document.getElementById('viewerBody');
            
            if (event.clip_path && event.clip_path.length > 0) {
                // If video clip exists, show it
                viewerBody.innerHTML = `
                    <div style="display:flex;flex-direction:column;height:100%;">
                        <video src="${event.clip_path}" controls autoplay style="flex:1;width:100%;object-fit:contain;"></video>
                        <div style="padding:8px;background:#1a1a2e;text-align:center;font-size:12px;color:#888;">
                            üìπ Recorded clip from detection event
                        </div>
                    </div>`;
            } else if (event.thumbnail_path && event.thumbnail_path.length > 0) {
                // Show thumbnail if available but no video
                viewerBody.innerHTML = `
                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;">
                        <img src="${event.thumbnail_path}" style="max-width:100%;max-height:80%;object-fit:contain;">
                        <div style="padding:12px;text-align:center;color:#888;font-size:13px;">
                            üì∑ Thumbnail from detection (no video clip recorded)
                        </div>
                    </div>`;
            } else {
                // No clip available - show message (old events before background worker)
                viewerBody.innerHTML = `
                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#6b7684;padding:20px;text-align:center;">
                        <div style="font-size:4rem;margin-bottom:15px;">üìπ</div>
                        <div style="font-size:16px;font-weight:600;margin-bottom:8px;">No Video Clip Available</div>
                        <div style="font-size:13px;color:#888;max-width:300px;">
                            This event was recorded before the background detection service was enabled. 
                            Future events will automatically include 1-minute video clips.
                        </div>
                        ${event.camera_id ? `
                            <div style="margin-top:15px;">
                                <a href="/camera/${event.camera_id}/settings/" class="btn btn-sm btn-secondary">
                                    ‚öôÔ∏è View Camera Settings
                                </a>
                            </div>
                        ` : ''}
                    </div>`;
            }
        } catch (error) {
            console.error('Error loading event:', error);
        }
    }
    
    let currentStream = null;
    
    function startLiveStream(element, cameraId) {
        // Stop any existing stream
        if (currentStream) {
            currentStream.src = '';
        }
        
        const img = element.querySelector('.stream-img');
        const playContent = element.querySelector('.play-content');
        
        img.src = `/video-feed/${cameraId}/`;
        img.style.display = 'block';
        if (playContent) playContent.style.display = 'none';
        
        currentStream = img;
    }
    
    // Stop stream when leaving page
    window.addEventListener('beforeunload', function() {
        if (currentStream) {
            currentStream.src = '';
        }
    });
    
    async function updateEventStatus(status) {
        if (!selectedEventId) {
            showToast('{{ t.no_events }}', 'error');
            return;
        }
        
        try {
            const response = await fetch(`/api/events/${selectedEventId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ status: status })
            });
            
            if (response.ok) {
                showToast('{{ t.success }}', 'success');
                window.location.reload();
            }
        } catch (error) {
            showToast('{{ t.error }}', 'error');
        }
    }
    
    async function deleteEvent() {
        if (!selectedEventId) {
            showToast('{{ t.no_events }}', 'error');
            return;
        }
        
        if (!confirm('{{ t.confirm_delete }}')) return;
        
        try {
            const response = await fetch(`/api/events/${selectedEventId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            if (response.ok) {
                showToast('{{ t.success }}', 'success');
                window.location.reload();
            }
        } catch (error) {
            showToast('{{ t.error }}', 'error');
        }
    }
    
    function filterBranchesByRegion() {
        const regionId = document.getElementById('regionFilter').value;
        const branchSelect = document.getElementById('branchFilter');
        const options = branchSelect.querySelectorAll('option');
        
        // Reset branch selection
        branchSelect.value = '';
        
        options.forEach(option => {
            if (option.value === '') {
                // Keep "All Branches" visible
                option.style.display = 'block';
                option.hidden = false;
            } else {
                const optionRegion = option.dataset.region;
                if (!regionId || optionRegion === regionId) {
                    option.style.display = 'block';
                    option.hidden = false;
                } else {
                    option.style.display = 'none';
                    option.hidden = true;
                }
            }
        });
    }
    
    function applyFilters() {
        const region = document.getElementById('regionFilter').value;
        const branch = document.getElementById('branchFilter').value;
        const eventType = document.getElementById('eventTypeFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        let params = new URLSearchParams();
        if (region) params.append('region', region);
        if (branch) params.append('branch', branch);
        if (eventType) params.append('type', eventType);
        if (dateFrom) params.append('from', dateFrom);
        if (dateTo) params.append('to', dateTo);
        
        window.location.href = `{% url 'cctv:video_logs' %}?${params.toString()}`;
    }
</script>
{% endblock %}
