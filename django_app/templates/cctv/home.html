{% extends 'cctv/base.html' %}

{% block title %}{{ t.home_title }} - {{ t.app_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-left">
        <p class="eyebrow">{{ t.home_subtitle }}</p>
        <h1>{{ t.home_title }}</h1>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid" id="statsGrid">
    <div class="stat-card blue">
        <span class="stat-label">{{ t.total_branches }}</span>
        <span class="stat-value" id="statBranches">-</span>
    </div>
    <div class="stat-card green">
        <span class="stat-label">{{ t.today_events }}</span>
        <span class="stat-value" id="statEvents">-</span>
    </div>
    <div class="stat-card yellow">
        <span class="stat-label">{{ t.online_cameras }}</span>
        <span class="stat-value" id="statCameras">-</span>
    </div>
    <div class="stat-card red">
        <span class="stat-label">{{ t.pending_review }}</span>
        <span class="stat-value" id="statPending">-</span>
    </div>
</div>

<!-- Branch List -->
<div class="panel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2>{{ t.total_branches }}</h2>
        <a href="{% url 'cctv:monitor_all' %}" class="link-btn">{{ t.view_all }} ‚Üí</a>
    </div>
    
    <div class="table home-table">
        <div class="table-head">
            <span>{{ t.branch_name }}</span>
            <span class="text-center">{{ t.event_count }}</span>
            <span class="text-right">{{ t.status }}</span>
        </div>
        <div class="table-body" id="branchList">
            <div class="loading">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>
    
    <div class="legend">
        <div class="legend-item">
            <span class="legend-dot green"></span>
            <span>{{ t.status_confirmed }}</span>
        </div>
        <div class="legend-item">
            <span class="legend-dot yellow"></span>
            <span>{{ t.status_reviewing }}</span>
        </div>
        <div class="legend-item">
            <span class="legend-dot red"></span>
            <span>{{ t.status_pending }}</span>
        </div>
    </div>
</div>

{% if user.is_admin %}
<!-- Background Detection Service Status (Admin Only) -->
<div class="panel" style="margin-top: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2>üîÑ {{ t.detection_service|default:"Detection Service" }}</h2>
        <div style="display: flex; gap: 10px;">
            <button onclick="startAllWorkers()" class="btn btn-primary btn-sm">‚ñ∂Ô∏è Start All</button>
            <button onclick="stopAllWorkers()" class="btn btn-secondary btn-sm">‚èπÔ∏è Stop All</button>
        </div>
    </div>
    
    <div id="workerStatus" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
        <div class="loading">
            <div class="loading-spinner"></div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Load home stats
    async function loadHomeStats() {
        try {
            const response = await fetch('{% url "cctv:api_home_stats" %}');
            const data = await response.json();
            
            document.getElementById('statBranches').textContent = data.total_branches || 0;
            document.getElementById('statEvents').textContent = data.today_events || 0;
            document.getElementById('statCameras').textContent = data.online_cameras || 0;
            document.getElementById('statPending').textContent = data.pending_review || 0;
            
            // Render branch list
            renderBranchList(data.branches || []);
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }
    
    {% if user.is_admin %}
    // Load worker status (Admin only)
    async function loadWorkerStatus() {
        try {
            const response = await fetch('{% url "cctv:api_workers_status" %}');
            const data = await response.json();
            
            const container = document.getElementById('workerStatus');
            const workers = Object.values(data.workers || {});
            
            if (workers.length === 0) {
                container.innerHTML = '<div style="color:#888;">No cameras configured</div>';
                return;
            }
            
            container.innerHTML = workers.map(w => `
                <div style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; border-left: 4px solid ${w.running ? (w.frames_processed > 0 ? '#22c55e' : '#f59e0b') : '#ef4444'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong>${w.camera_id}</strong>
                        <span class="status-pill ${w.running ? (w.frames_processed > 0 ? 'status-confirmed' : 'status-reviewing') : 'status-pending'}">
                            ${w.running ? (w.frames_processed > 0 ? 'Running' : w.status || 'Starting...') : 'Stopped'}
                        </span>
                    </div>
                    <div style="font-size: 12px; color: #888;">
                        <div>üìπ ${w.camera_name}</div>
                        ${w.running ? `
                            <div>‚è±Ô∏è Uptime: ${w.uptime}</div>
                            <div>üìä Frames: ${w.frames_processed?.toLocaleString() || 0}</div>
                            <div>üéØ Events: ${w.events_detected || 0}</div>
                            ${w.last_error ? `<div style="color: #f59e0b;">‚ö†Ô∏è ${w.last_error}</div>` : ''}
                        ` : `
                            <div style="color: #ef4444;">${w.last_error || 'Not running'}</div>
                        `}
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading worker status:', error);
        }
    }
    
    async function startAllWorkers() {
        if (!confirm('Start background detection for all cameras?')) return;
        try {
            const response = await fetch('{% url "cctv:api_workers_start_all" %}', {
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            });
            const data = await response.json();
            alert(`Started ${data.count} workers`);
            loadWorkerStatus();
        } catch (error) {
            alert('Error starting workers');
        }
    }
    
    async function stopAllWorkers() {
        if (!confirm('Stop all background detection workers?')) return;
        try {
            const response = await fetch('{% url "cctv:api_workers_stop_all" %}', {
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            });
            const data = await response.json();
            alert(`Stopped ${data.count} workers`);
            loadWorkerStatus();
        } catch (error) {
            alert('Error stopping workers');
        }
    }
    {% endif %}
    
    function renderBranchList(branches) {
        const container = document.getElementById('branchList');
        
        if (branches.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <p class="empty-state-text">{{ t.no_data }}</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = branches.map(branch => `
            <a href="{% url 'cctv:monitor_local' %}?branch=${branch.id}" class="table-row clickable">
                <span class="branch-name">${branch.name}</span>
                <span class="text-center">${branch.event_count}</span>
                <span class="text-right">
                    <span class="status-pill status-${branch.status}">${getStatusText(branch.status)}</span>
                </span>
            </a>
        `).join('');
    }
    
    function getStatusText(status) {
        const statusMap = {
            'confirmed': '{{ t.status_confirmed }}',
            'reviewing': '{{ t.status_reviewing }}',
            'pending': '{{ t.status_pending }}'
        };
        return statusMap[status] || status;
    }
    
    // Load on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadHomeStats();
        {% if user.is_admin %}
        loadWorkerStatus();
        {% endif %}
    });
    
    // Refresh every 30 seconds
    setInterval(loadHomeStats, 30000);
    {% if user.is_admin %}
    setInterval(loadWorkerStatus, 5000);  // Refresh worker status every 5 seconds
    {% endif %}
</script>
{% endblock %}
