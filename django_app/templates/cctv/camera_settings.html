{% extends 'cctv/base.html' %}
{% load static %}

{% block title %}{{ camera.name }} - {{ t.camera_settings }} - {{ t.app_name }}{% endblock %}

{% block extra_css %}
<style>
    .settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
    }
    
    .settings-section {
        background: #ffffff;
        border: 1px solid var(--border-light);
        border-radius: 16px;
        padding: 24px;
    }
    
    .settings-section h3 {
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-light);
    }
    
    .zone-canvas-container {
        position: relative;
        background: #1a1a2e;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 16px;
        min-height: 300px;
    }
    
    #liveVideo {
        display: block;
        width: 100%;
        height: auto;
    }
    
    #zoneCanvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: auto;
        cursor: crosshair;
        z-index: 2;
        background: transparent;
    }
    
    .zone-controls {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 16px;
    }
    
    .slider-group {
        margin-bottom: 20px;
    }
    
    .slider-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .slider-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .slider-value {
        font-size: 14px;
        font-weight: 700;
        color: var(--blue-500);
        background: var(--blue-50);
        padding: 4px 12px;
        border-radius: 6px;
    }
    
    .slider-input {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: var(--gray-100);
        outline: none;
        -webkit-appearance: none;
    }
    
    .slider-input::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--blue-500);
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(49, 130, 246, 0.4);
    }
    
    .toggle-group {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        background: var(--gray-50);
        border-radius: 12px;
        margin-bottom: 12px;
    }
    
    .toggle-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .toggle-label {
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .toggle-desc {
        font-size: 13px;
        color: var(--text-secondary);
    }
    
    .toggle-switch {
        position: relative;
        width: 52px;
        height: 28px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background: var(--gray-200);
        border-radius: 14px;
        transition: 0.3s;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    input:checked + .toggle-slider {
        background: var(--blue-500);
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }
    
    .video-preview {
        background: var(--gray-700);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }
    
    .video-preview img {
        width: 100%;
        display: block;
    }
    
    .zone-overlay {
        position: absolute;
        border: 3px dashed var(--blue-500);
        background: rgba(49, 130, 246, 0.15);
        pointer-events: none;
    }
    
    .connection-status {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: var(--gray-50);
        border-radius: 8px;
        margin-bottom: 16px;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    .status-indicator.online {
        background: var(--green-500);
    }
    
    .status-indicator.offline {
        background: var(--red-500);
        animation: none;
    }
    
    .status-indicator.testing {
        background: var(--yellow-500);
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .status-text {
        flex: 1;
        font-weight: 600;
    }
    
    @media (max-width: 1024px) {
        .settings-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-left">
        <a href="{% url 'cctv:manage_branch_detail' camera.branch.id %}" class="back-link">‚Üê {{ camera.branch.name }}</a>
        <h1>{{ camera.name }}</h1>
        <p class="text-muted">{{ t.camera_settings }} - {{ camera.camera_id }}</p>
    </div>
    <div class="page-actions">
        <button class="btn btn-primary" onclick="saveAllSettings()">{{ t.save }}</button>
    </div>
</div>

<div class="settings-grid">
    <!-- Live Video Section (Always visible) -->
    <div class="settings-section" id="liveVideoSection">
        <h3>üìπ {{ t.live }}</h3>
        
        <!-- Connection Status -->
        <div class="connection-status" id="connectionStatus">
            <span class="status-indicator {% if camera.status == 'online' %}online{% else %}offline{% endif %}"></span>
            <span class="status-text">{% if camera.status == 'online' %}{{ t.status_online }} ‚úì{% else %}{{ t.status_offline }}{% endif %}</span>
            <button class="btn btn-sm btn-primary" onclick="testConnection()">üîå Test Connection</button>
            <button class="btn btn-sm btn-secondary" onclick="startLivePreview()">‚ñ∂ Live Preview</button>
        </div>
        
        <!-- Video Dimensions Display -->
        <div class="video-dimensions" id="videoDimensions" style="display: none; padding: 8px 12px; background: var(--blue-50); border-radius: 8px; margin-bottom: 12px; font-size: 13px;">
            <span style="color: var(--blue-600); font-weight: 600;">üìê {{ t.video_dimensions|default:"Video Dimensions" }}:</span>
            <span id="videoDimensionsText" style="color: var(--text-primary); margin-left: 8px;">-</span>
        </div>
        
        <div class="zone-canvas-container" id="videoContainer">
            <img id="liveVideo" src="" alt="Live Preview" style="display:none;">
            <canvas id="zoneCanvas" width="1024" height="576"></canvas>
        </div>
        
        <!-- Cashier Zone Toggle Button (Hidden by default, click to show) -->
        <div class="toggle-group" style="margin-top: 16px;">
            <div class="toggle-info">
                <span class="toggle-label">{{ t.setup_cashier_zone }}</span>
                <span class="toggle-desc">{{ t.cashier_zone }}</span>
            </div>
            <button class="btn btn-sm btn-ghost" id="toggleCashierZoneBtn" onclick="toggleCashierZoneSettings()">
                <span id="cashierZoneBtnText">‚ñº Show</span>
            </button>
        </div>
        
        <!-- Cashier Zone Settings (Hidden by default) -->
        <div id="cashierZoneSettings" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-light);">
            <div class="toggle-group">
                <div class="toggle-info">
                    <span class="toggle-label">{{ t.zone_enabled }}</span>
                    <span class="toggle-desc">{{ t.cashier_zone }}</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="zoneEnabled" {% if camera.cashier_zone_enabled %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="zone-controls">
                <div class="form-group">
                    <label>{{ t.zone_x }}</label>
                    <input type="number" id="zoneX" value="{{ camera.cashier_zone_x }}" min="0" max="640">
                </div>
                <div class="form-group">
                    <label>{{ t.zone_y }}</label>
                    <input type="number" id="zoneY" value="{{ camera.cashier_zone_y }}" min="0" max="480">
                </div>
                <div class="form-group">
                    <label>{{ t.zone_width }}</label>
                    <input type="number" id="zoneWidth" value="{{ camera.cashier_zone_width }}" min="50" max="640">
                </div>
                <div class="form-group">
                    <label>{{ t.zone_height }}</label>
                    <input type="number" id="zoneHeight" value="{{ camera.cashier_zone_height }}" min="50" max="480">
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="resetZone()">{{ t.reset_zone }}</button>
                <button class="btn btn-primary" onclick="saveZone()">{{ t.save_zone }}</button>
            </div>
        </div>
    </div>
    
    <!-- Detection Settings -->
    <div class="settings-section">
        <h3>{{ t.detection_settings }}</h3>
        
        <!-- Show Cashier Zone Box Toggle (UI only - hidden by default) -->
        <div class="toggle-group" style="background: var(--yellow-50); border: 1px solid var(--yellow-200);">
            <div class="toggle-info">
                <span class="toggle-label">{{ t.show_zone_overlay }}</span>
                <span class="toggle-desc">{{ t.cashier_zone }}</span>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="showZoneOverlay" onchange="toggleZoneOverlay()">
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <!-- Detection Toggles -->
        <div class="toggle-group">
            <div class="toggle-info">
                <span class="toggle-label">{{ t.detect_cash }}</span>
                <span class="toggle-desc">{{ t.event_cash }}</span>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="detectCash" {% if camera.detect_cash %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="toggle-group">
            <div class="toggle-info">
                <span class="toggle-label">{{ t.detect_violence }}</span>
                <span class="toggle-desc">{{ t.event_violence }}</span>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="detectViolence" {% if camera.detect_violence %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="toggle-group">
            <div class="toggle-info">
                <span class="toggle-label">{{ t.detect_fire }}</span>
                <span class="toggle-desc">{{ t.event_fire }}</span>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="detectFire" {% if camera.detect_fire %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <hr style="margin: 24px 0; border: 0; border-top: 1px solid var(--border-light);">
        
        <h4 style="margin-bottom: 16px;">{{ t.confidence_threshold }}</h4>
        
        <!-- Cash Confidence Slider -->
        <div class="slider-group">
            <div class="slider-header">
                <span class="slider-label">{{ t.cash_confidence }}</span>
                <span class="slider-value" id="cashConfValue">{{ camera.cash_confidence|floatformat:2 }}</span>
            </div>
            <input type="range" class="slider-input" id="cashConfidence" 
                   min="0" max="1" step="0.05" value="{{ camera.cash_confidence }}"
                   oninput="updateSliderValue('cash')">
        </div>
        
        <!-- Hand Touch Distance Slider (pixels) -->
        <div class="slider-group">
            <div class="slider-header">
                <span class="slider-label">{{ t.hand_touch_distance }}</span>
                <span class="slider-value" id="handDistanceValue">{{ camera.hand_touch_distance|default:100 }}px</span>
            </div>
            <input type="range" class="slider-input" id="handTouchDistance" 
                   min="30" max="300" step="10" value="{{ camera.hand_touch_distance|default:100 }}"
                   oninput="updateSliderValue('handDistance')">
        </div>
        
        <!-- Violence Confidence Slider -->
        <div class="slider-group">
            <div class="slider-header">
                <span class="slider-label">{{ t.violence_confidence }}</span>
                <span class="slider-value" id="violenceConfValue">{{ camera.violence_confidence|floatformat:2 }}</span>
            </div>
            <input type="range" class="slider-input" id="violenceConfidence" 
                   min="0" max="1" step="0.05" value="{{ camera.violence_confidence }}"
                   oninput="updateSliderValue('violence')">
        </div>
        
        <!-- Fire Confidence Slider -->
        <div class="slider-group">
            <div class="slider-header">
                <span class="slider-label">{{ t.fire_confidence }}</span>
                <span class="slider-value" id="fireConfValue">{{ camera.fire_confidence|floatformat:2 }}</span>
            </div>
            <input type="range" class="slider-input" id="fireConfidence" 
                   min="0" max="1" step="0.05" value="{{ camera.fire_confidence }}"
                   oninput="updateSliderValue('fire')">
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const cameraId = {{ camera.id }};
    const canvas = document.getElementById('zoneCanvas');
    const ctx = canvas.getContext('2d');
    
    let isDrawing = false;
    let startX, startY;
    let videoActive = false;
    let canvasWidth = 1024;
    let canvasHeight = 576;
    let cashierZoneVisible = false;
    let showZoneOverlay = false;  // Yellow box hidden by default
    let currentZone = {
        x: {{ camera.cashier_zone_x }},
        y: {{ camera.cashier_zone_y }},
        width: {{ camera.cashier_zone_width }},
        height: {{ camera.cashier_zone_height }}
    };
    
    // Toggle zone overlay visibility (yellow box on video)
    function toggleZoneOverlay() {
        showZoneOverlay = document.getElementById('showZoneOverlay').checked;
        drawZone();
    }
    
    // Toggle cashier zone settings visibility
    function toggleCashierZoneSettings() {
        const settings = document.getElementById('cashierZoneSettings');
        const btnText = document.getElementById('cashierZoneBtnText');
        cashierZoneVisible = !cashierZoneVisible;
        
        if (cashierZoneVisible) {
            settings.style.display = 'block';
            btnText.textContent = '‚ñ≤ Hide';
            // Auto-enable zone overlay when editing
            showZoneOverlay = true;
            document.getElementById('showZoneOverlay').checked = true;
            drawZone();
        } else {
            settings.style.display = 'none';
            btnText.textContent = '‚ñº Show';
        }
    }
    
    // Initialize canvas with placeholder or transparent overlay
    function initCanvas() {
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        
        if (!videoActive) {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#6b7684';
            ctx.font = '18px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Click "Live Preview" to start video', canvas.width / 2, canvas.height / 2);
        }
        drawZone();
    }
    
    function drawZone() {
        // Clear canvas - transparent if video is active, dark if not
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if (!videoActive) {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#6b7684';
            ctx.font = '18px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Click "Live Preview" to start video', canvas.width / 2, canvas.height / 2);
        }
        
        // Only draw zone rectangle when overlay toggle is ON
        if (!showZoneOverlay) return;
        
        // Draw zone rectangle with yellow color for visibility
        ctx.strokeStyle = '#ffcc00';
        ctx.lineWidth = 3;
        ctx.setLineDash([10, 5]);
        ctx.strokeRect(currentZone.x, currentZone.y, currentZone.width, currentZone.height);
        
        // Fill with transparent yellow
        ctx.fillStyle = 'rgba(255, 204, 0, 0.2)';
        ctx.fillRect(currentZone.x, currentZone.y, currentZone.width, currentZone.height);
        
        // Label with background for visibility
        ctx.setLineDash([]);
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(currentZone.x, currentZone.y, 120, 28);
        ctx.fillStyle = '#ffcc00';
        ctx.font = 'bold 14px Pretendard Variable';
        ctx.textAlign = 'left';
        ctx.fillText('CASHIER ZONE', currentZone.x + 8, currentZone.y + 19);
        
        // Update input fields
        document.getElementById('zoneX').value = Math.round(currentZone.x);
        document.getElementById('zoneY').value = Math.round(currentZone.y);
        document.getElementById('zoneWidth').value = Math.round(currentZone.width);
        document.getElementById('zoneHeight').value = Math.round(currentZone.height);
    }
    
    // Mouse events for drawing zone
    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        startX = (e.clientX - rect.left) * scaleX;
        startY = (e.clientY - rect.top) * scaleY;
        isDrawing = true;
    });
    
    canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        const currentX = (e.clientX - rect.left) * scaleX;
        const currentY = (e.clientY - rect.top) * scaleY;
        
        currentZone = {
            x: Math.min(startX, currentX),
            y: Math.min(startY, currentY),
            width: Math.abs(currentX - startX),
            height: Math.abs(currentY - startY)
        };
        
        drawZone();
    });
    
    canvas.addEventListener('mouseup', () => {
        isDrawing = false;
    });
    
    canvas.addEventListener('mouseleave', () => {
        isDrawing = false;
    });
    
    // Update zone from input fields
    ['zoneX', 'zoneY', 'zoneWidth', 'zoneHeight'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
            currentZone = {
                x: parseInt(document.getElementById('zoneX').value) || 0,
                y: parseInt(document.getElementById('zoneY').value) || 0,
                width: parseInt(document.getElementById('zoneWidth').value) || 100,
                height: parseInt(document.getElementById('zoneHeight').value) || 100
            };
            drawZone();
        });
    });
    
    function resetZone() {
        currentZone = { x: 0, y: 0, width: 640, height: 480 };
        drawZone();
    }
    
    function updateSliderValue(type) {
        if (type === 'handDistance') {
            const slider = document.getElementById('handTouchDistance');
            const display = document.getElementById('handDistanceValue');
            display.textContent = slider.value + 'px';
        } else {
            const slider = document.getElementById(type + 'Confidence');
            const display = document.getElementById(type + 'ConfValue');
            display.textContent = parseFloat(slider.value).toFixed(2);
        }
    }
    
    async function saveZone() {
        const data = {
            x: currentZone.x,
            y: currentZone.y,
            width: currentZone.width,
            height: currentZone.height,
            enabled: document.getElementById('zoneEnabled').checked
        };
        
        try {
            const response = await fetch(`/api/cameras/${cameraId}/set-zone/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                showToast('{{ t.settings_saved }}', 'success');
            } else {
                showToast('{{ t.error }}', 'error');
            }
        } catch (error) {
            showToast('{{ t.error }}', 'error');
        }
    }
    
    async function saveAllSettings() {
        const data = {
            detect_cash: document.getElementById('detectCash').checked,
            detect_violence: document.getElementById('detectViolence').checked,
            detect_fire: document.getElementById('detectFire').checked,
            cash_confidence: parseFloat(document.getElementById('cashConfidence').value),
            hand_touch_distance: parseInt(document.getElementById('handTouchDistance').value),
            violence_confidence: parseFloat(document.getElementById('violenceConfidence').value),
            fire_confidence: parseFloat(document.getElementById('fireConfidence').value),
            cashier_zone: {
                x: currentZone.x,
                y: currentZone.y,
                width: currentZone.width,
                height: currentZone.height,
                enabled: document.getElementById('zoneEnabled').checked
            }
        };
        
        try {
            const response = await fetch(`/api/cameras/${cameraId}/settings/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                showToast('{{ t.settings_saved }}', 'success');
            } else {
                showToast('{{ t.error }}', 'error');
            }
        } catch (error) {
            showToast('{{ t.error }}', 'error');
        }
    }
    
    // Initialize
    initCanvas();
    
    // Test camera connection and show live preview
    async function testConnection() {
        const statusDiv = document.getElementById('connectionStatus');
        const indicator = statusDiv.querySelector('.status-indicator');
        const statusText = statusDiv.querySelector('.status-text');
        const liveVideo = document.getElementById('liveVideo');
        
        indicator.className = 'status-indicator testing';
        statusText.textContent = 'Testing connection...';
        
        try {
            // Test by calling API to check connection
            const response = await fetch(`/api/cameras/${cameraId}/test-connection/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            
            if (data.success && data.online) {
                indicator.className = 'status-indicator online';
                statusText.textContent = '{{ t.status_online }} ‚úì';
                
                // Show live video feed
                liveVideo.src = `/video-feed/${cameraId}/`;
                liveVideo.style.display = 'block';
                videoActive = true;
                drawZone();  // Redraw zone with transparent background
                showToast('Camera connected!', 'success');
            } else {
                indicator.className = 'status-indicator offline';
                statusText.textContent = '{{ t.status_offline }} - ' + (data.error || 'Cannot connect');
                liveVideo.style.display = 'none';
                videoActive = false;
                drawZone();
                showToast(data.error || 'Connection failed', 'error');
            }
        } catch (error) {
            indicator.className = 'status-indicator offline';
            statusText.textContent = '{{ t.status_offline }} - Error';
            showToast('Connection test failed', 'error');
        }
    }
    
    // Handle video load error
    document.getElementById('liveVideo').onerror = function() {
        this.style.display = 'none';
        videoActive = false;
        drawZone();
        const indicator = document.querySelector('.status-indicator');
        const statusText = document.querySelector('.status-text');
        indicator.className = 'status-indicator offline';
        statusText.textContent = '{{ t.status_offline }}';
        // Hide dimensions when video fails
        document.getElementById('videoDimensions').style.display = 'none';
    };
    
    // Handle video load to resize canvas and show dimensions
    document.getElementById('liveVideo').onload = function() {
        // Update canvas size to match video actual display size
        const video = this;
        canvasWidth = video.naturalWidth || video.width || 1024;
        canvasHeight = video.naturalHeight || video.height || 576;
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        videoActive = true;
        drawZone();
        
        // Show video dimensions
        document.getElementById('videoDimensions').style.display = 'block';
        document.getElementById('videoDimensionsText').textContent = `${canvasWidth} √ó ${canvasHeight} px`;
    };
    
    // Start live preview without connection test
    function startLivePreview() {
        const liveVideo = document.getElementById('liveVideo');
        const indicator = document.querySelector('.status-indicator');
        const statusText = document.querySelector('.status-text');
        
        liveVideo.src = `/video-feed/${cameraId}/`;
        liveVideo.style.display = 'block';
        videoActive = true;
        drawZone();  // Redraw zone with transparent background
        
        indicator.className = 'status-indicator online';
        statusText.textContent = '{{ t.status_online }} ‚úì';
    }
    
    // Auto-start live preview if camera is online
    {% if camera.status == 'online' %}
    document.addEventListener('DOMContentLoaded', function() {
        startLivePreview();
    });
    {% endif %}
</script>
{% endblock %}
