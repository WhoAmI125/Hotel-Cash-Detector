{% extends 'cctv/base.html' %}

{% block title %}지점관리 - Hotel CCTV Monitoring{% endblock %}

{% block content %}
<div class="panel">
    <div class="page-header">
        <div>
            <p class="eyebrow">관리 · 지점관리</p>
            <h1>지점 리스트</h1>
        </div>
    </div>
    
    <div class="manage-inline">
        <form class="manage-filters-inline" method="get">
            <div class="filter-group">
                <label>지역</label>
                <select name="region">
                    <option value="전체" {% if filters.region == '전체' %}selected{% endif %}>전체</option>
                    {% for region in regions %}
                    <option value="{{ region.name }}" {% if filters.region == region.name %}selected{% endif %}>{{ region.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label>지점명</label>
                <input name="search" placeholder="지점명 검색" value="{{ filters.search }}">
            </div>
            <button class="ghost-button small" type="submit">검색</button>
        </form>
        <div class="manage-create inline-create">
            <button class="primary-button" onclick="showCreateBranchModal()">지점 생성</button>
        </div>
    </div>
    
    <div class="table manage-table">
        <div class="table-head">
            <span>지점</span>
            <span>지역</span>
            <span>액션</span>
        </div>
        <div class="table-body" id="branchTableBody">
            {% for branch in branches %}
            <div class="table-row events clickable" onclick="goToBranchDetail({{ branch.id }})">
                <span class="branch-name">{{ branch.name }}</span>
                <span>{{ branch.region.name }}</span>
                <button class="danger-button small" onclick="event.stopPropagation(); confirmDeleteBranch({{ branch.id }}, '{{ branch.name }}')">삭제</button>
            </div>
            {% empty %}
            <div class="table-row empty-row">
                <span class="empty-text">등록된 지점이 없습니다.</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Create Branch Modal -->
<div id="createBranchModal" class="modal-backdrop" style="display: none;" onclick="closeCreateBranchModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>지점 생성</h3>
            <button class="ghost-button small" onclick="closeCreateBranchModal()">닫기</button>
        </div>
        <div class="modal-body">
            <form id="createBranchForm" onsubmit="createBranch(event)">
                <div class="manage-create">
                    <input type="text" id="newBranchName" placeholder="지점명" required>
                    <select id="newBranchRegion">
                        {% for region in regions %}
                        <option value="{{ region.name }}">{{ region.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="primary-button">생성</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirm Modal -->
<div id="deleteConfirmModal" class="modal-backdrop" style="display: none;" onclick="closeDeleteConfirmModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>삭제 확인</h3>
            <button class="ghost-button small" onclick="closeDeleteConfirmModal()">닫기</button>
        </div>
        <div class="modal-body">
            <div class="placeholder">
                <strong id="deleteBranchName"></strong> 지점을 삭제하시겠습니까?
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 16px;">
                <button class="ghost-button small" onclick="closeDeleteConfirmModal()">취소</button>
                <button class="danger-button small" onclick="deleteBranch()">삭제</button>
            </div>
        </div>
    </div>
</div>

<script>
let deleteBranchId = null;

function goToBranchDetail(branchId) {
    window.location.href = `/manage/branches/${branchId}/`;
}

function showCreateBranchModal() {
    document.getElementById('createBranchModal').style.display = 'flex';
}

function closeCreateBranchModal() {
    document.getElementById('createBranchModal').style.display = 'none';
    document.getElementById('createBranchForm').reset();
}

function createBranch(event) {
    event.preventDefault();
    
    const data = {
        name: document.getElementById('newBranchName').value,
        region: document.getElementById('newBranchRegion').value
    };
    
    fetch('/api/branches/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('지점이 생성되었습니다.');
            window.location.reload();
        } else {
            alert('오류: ' + (result.error || '지점 생성 실패'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('지점 생성 중 오류가 발생했습니다.');
    });
}

function confirmDeleteBranch(branchId, branchName) {
    deleteBranchId = branchId;
    document.getElementById('deleteBranchName').textContent = branchName;
    document.getElementById('deleteConfirmModal').style.display = 'flex';
}

function closeDeleteConfirmModal() {
    document.getElementById('deleteConfirmModal').style.display = 'none';
    deleteBranchId = null;
}

function deleteBranch() {
    if (!deleteBranchId) return;
    
    fetch(`/api/branches/${deleteBranchId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('지점이 삭제되었습니다.');
            window.location.reload();
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
